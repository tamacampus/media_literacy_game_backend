/**
 * 謝罪文分析サービス
 *
 * Google Gemini AIを使用して謝罪文の適切性を評価
 */

import type { AnalysisResult } from './types'
import { callGeminiAPI } from './geminiClient'

/**
 * 謝罪文をメディアリテラシーの観点から分析する関数
 *
 * @param text - 分析対象の謝罪文
 * @param apiKey - Google Gemini APIキー
 * @returns 分析結果（説明文とリスクレベル）
 * @throws Error - Gemini API呼び出しに失敗した場合
 */
export async function analyzeApology(text: string, apiKey: string): Promise<AnalysisResult> {
  /**
   * プロンプトの構築（謝罪文用）
   * Geminiに送信する指示文を作成
   *
   * 重要なポイント：
   * - 小学生でも理解できる平易な日本語
   * - 50文字以内の簡潔な説明
   * - 謝罪文特有の評価基準
   */
  const prompt = `
以下の謝罪文を分析して、適切性とメディアリテラシーの観点から評価してください。
注意事項：この謝罪文の内容はユーザーには見えないため、ここに記載されている内容をそのまま出力しないでください。返答は短く、小学生がわかるレベルの平易な1文の日本語でお願いします。
絶対に短く出力してください。50文字以内でお願いします。

評価基準（謝罪文として重要な要素）：
- 誠意と真摯さが伝わるか
- 問題の認識と責任の明確化
- 具体的な改善策の提示
- 言い訳や責任逃れの有無
- 被害者や関係者への配慮
- 曖昧な表現や逃げ口上の使用
- 形式的すぎる定型文の使用

謝罪文: "${text}"

謝罪文としての適切性を厳しく評価してください。
企業や公人の謝罪文として不適切な点があれば、リスクレベルを高めに設定してください。
特に、誠意が感じられない、責任を曖昧にしている、具体性に欠ける場合は厳しく評価してください。
explanationには、謝罪文として不適切な理由と改善すべき点を具体的に指摘してください。
注意事項：この謝罪文の内容はユーザーには見えないため、ここに記載されている内容をそのまま出力しないでください。返答は短く、小学生がわかるレベルの平易な1文の日本語でお願いします。
絶対に短く出力してください。50文字以内でお願いします。
`

  // 共通関数を使用してGemini APIを呼び出す
  return callGeminiAPI(prompt, apiKey, 'Failed to analyze apology')
}